# Session 2025-10-07 - GUI Console Design & Demo Refinement

**Date**: Tuesday, October 7th, 2025
**Focus**: Phase 12 demo validation, GUI console architecture design
**Duration**: Full day session
**Status**: Design documents complete, ready for Wednesday implementation

---

## Session Overview

This session focused on completing Phase 12 demo validation and discovering the need for a unified GUI console. Key achievements:

1. **Fixed Demo Mode Timing** - Implemented TestingConfiguration for corruption detection testing
2. **DataGrip Integration** - Replaced SQLiteBrowser across all demo scenarios
3. **User Experience Discovery** - Identified fragmented demo experience as critical issue
4. **Architecture Decision** - Designed Go + htmx Dockerized console (separate from service)
5. **Documentation Complete** - Created comprehensive design and task list documents

---

## Key Decisions Made

### 1. Build Separate GUI Console

**User's feedback**: *"overall this is not a great user experience"*

**Problem**: PowerShell demos require:
- Multiple terminals (script output + service logs)
- Multiple File Explorer windows
- DataGrip for database queries
- Manual correlation between all views

**Solution**: Dockerized web-based GUI console with two modes:
- **Production Mode**: Unified real-time monitoring dashboard
- **Demo Mode**: One-click scenario execution with progress streaming

### 2. Technology Stack: Go + htmx

**User's feedback**: *"I love the sound of Go + htmx but you will be doing all the work as I have no idea about this!"*

**Chosen Stack**:
- **Backend**: Go 1.21+ (Google's language, containerization standard)
- **Frontend**: htmx 1.9+ (14KB JavaScript library, no build pipeline)
- **Container**: Docker with Alpine Linux (15MB final image)
- **Database**: Read-only SQLite access (zero interference with service)

**Why Not Alternatives**:
- âŒ **Blazor Server**: 200MB+ container, SignalR complexity, .NET dependencies
- âŒ **React/Vue/Angular**: 1000+ npm packages, massive CVE scanning burden
- âŒ **Desktop GUI**: NHS deployment blockers (AppLocker, code signing, 12-24 week approval)
- âŒ **Integrated into Service**: Breaks separation of concerns, introduces risk

**Key Advantages**:
- 3 Go packages vs 1000+ for React
- 15MB container vs 200MB+ for .NET
- No npm/webpack/build pipeline
- Easy vulnerability scanning (Trivy, gosec, Nancy)
- Industry standard for containerized apps

### 3. Keep SQLite (Not Switch to SQL Server)

**User's question**: *"should we use a more robust DB as a service, does this even make sense?"*

**Decision**: Keep SQLite

**Rationale**:
- Mission-critical proven (aircraft, medical devices, military systems)
- Perfect for single-server sequential workloads
- WAL mode provides crash-safety
- Used in more systems than all other databases combined
- Only switch if: multi-site replication, 100+ concurrent writers, or NHS policy mandates SQL Server

### 4. Deployment Model Clarified

**User's reality check**: *"really, you think I can just drop some random exe file onto a windows machine in the NHS and run it!!!"*

**Deployment Scenarios**:
1. **For Demos (now)**: Run console on development laptop with Docker Desktop
2. **For NHS Production (future)**: Submit Docker container for security scanning and approval

**NHS Constraints**:
- Application whitelisting (AppLocker)
- No local admin rights
- Code signing requirements
- 12-24 week software approval process
- Mandatory security scanning

---

## Technical Work Completed

### 1. Demo Mode Timing Implementation

**Problem**: Scenario 2 (Corruption Detection) couldn't work because verification happened immediately after copy.

**Solution**:
- Added `Testing` configuration section to `appsettings.Demo.json`
- Created `TestingConfiguration` class with `VerificationDelaySeconds` setting
- Modified `VerificationOrchestrator.cs` to inject 10-second delay in Demo mode
- Added comprehensive logging for demo mode delays

**Files Modified**:
- `src/Forker.Service/appsettings.Demo.json`
- `src/Forker.Infrastructure/Services/VerificationOrchestrator.cs`

**Configuration**:
```json
"Testing": {
  "EnableTestMode": true,
  "VerificationDelaySeconds": 10,
  "VerboseTestLogging": true
}
```

**Result**: Corruption can now be introduced during delay window, verification detects mismatch.

---

### 2. DataGrip Integration

**Changed**: Replaced SQLiteBrowser with DataGrip across all 5 demo scenarios.

**Why**: DataGrip is industry-standard, more reliable, better SQL support.

**Created**: `scripts/Open-ForkerDatabase-Demo.sql` with curated queries:
- Quick Status Query (recent 20 jobs)
- Data Integrity Check (hash comparison)
- State Transitions (job lifecycle tracking)
- Active Jobs Query
- Quarantine Inspection

**Fixed**: SQL reserved word bug - changed table alias from `to` to `t_o`

**Files Modified**:
- All 5 scenario scripts (Run-Scenario*.ps1)
- `scripts/Demo-Utilities.ps1` (Start-DataGrip function)

---

### 3. Script Fixes and Improvements

**Corruption Function Fix**:
- **Bug**: Random byte might equal original value (hash wouldn't change)
- **Fix**: Read current byte and XOR with 0xFF (guaranteed bit flip)
- **File**: `scripts/Demo-Utilities.ps1`

**Encoding Fix**:
- **Bug**: Unicode characters (âœ“) caused PowerShell parser errors
- **Fix**: Replaced with ASCII equivalents ([OK], [INFO])
- **File**: `scripts/Cleanup-DemoEnvironment.ps1`

**Parameter Fix**:
- **Bug**: `-Filter` doesn't support array of patterns
- **Fix**: Changed to `-Include` with `-Recurse`
- **File**: `scripts/Cleanup-DemoEnvironment.ps1`

**Variable Fix**:
- **Bug**: `$finalSize` undefined in Scenario 5 (divide by zero)
- **Fix**: Capture file size before closing stream
- **File**: `scripts/Run-Scenario5-StabilityDetection.ps1`

**File Explorer Cleanup**:
- **Improved**: Window matching logic (LocationName + LocationURL)
- **Issue**: COM automation is fragile, but best available option
- **File**: `scripts/Demo-Utilities.ps1`

---

### 4. Environment Configuration Fix

**Problem**: Service loading Production config even when `$env:ASPNETCORE_ENVIRONMENT = "Demo"` set.

**Root Cause**: `Program.cs` wasn't detecting environment variable or loading overlay configs.

**Solution**:
```csharp
var environment = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") ?? "Production";
var configuration = new ConfigurationBuilder()
    .SetBasePath(Directory.GetCurrentDirectory())
    .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
    .AddJsonFile($"appsettings.{environment}.json", optional: true, reloadOnChange: true)
    .AddEnvironmentVariables()
    .Build();

Log.Information("Starting with environment: {Environment}", environment);
```

**File Modified**: `src/Forker.Service/Program.cs`

**Result**: Demo mode now correctly loads `C:\ForkerDemo` paths.

---

### 5. Created Start-ForkerDemo.ps1

**Purpose**: Convenience script to start service in Demo mode.

**File**: `scripts/Start-ForkerDemo.ps1`

**Features**:
- Sets `ASPNETCORE_ENVIRONMENT=Demo`
- Navigates to service directory
- Runs `dotnet run --environment Demo`
- Clear user feedback with colored output

---

## Design Documents Created

### 1. console-design.md (500+ lines)

**Contents**:
- Executive summary of console purpose
- Technology selection (Go + htmx) with detailed rationale
- Architecture overview with ASCII diagrams
- 6 major design decisions with rationale
- Arguments against 5 alternative approaches (Blazor, React, Desktop GUI, etc.)
- Security & vulnerability scanning approach
- NHS deployment considerations
- Implementation approach (4 phases, 19-26 hours)
- Technology stack summary table

**Key Section - Architecture**:
```
Service (Critical Path)          Console (Monitoring Layer)
â”œâ”€â”€ Pure .NET 8                  â”œâ”€â”€ Go + htmx
â”œâ”€â”€ SQLite with WAL              â”œâ”€â”€ Browser-based UI
â”œâ”€â”€ No external deps             â”œâ”€â”€ Docker container
â”œâ”€â”€ Windows Service              â”œâ”€â”€ 15MB image
â””â”€â”€ Minimal attack surface       â””â”€â”€ Read-only DB access
```

**File**: `console-design.md`

---

### 2. console-dev-task-list.md (700+ lines)

**Contents**:
- Detailed 4-phase implementation plan (19-26 hours estimated)
- Phase 1: Core Infrastructure (4-6h) - SQLite integration, HTTP server
- Phase 2: Production Dashboard (6-8h) - Real-time monitoring with SSE
- Phase 3: Demo Mode (6-8h) - Automated scenario execution engine
- Phase 4: Polish & Security (3-4h) - Docker containerization, vulnerability scanning
- Specific tasks with code examples
- Success criteria for each task
- Testing & validation checklists
- Deployment checklists (Dev laptop + NHS production)
- Dependency summary (attack surface analysis)

**Phase 1 Example Task**:
```
Task 1.2: SQLite Read-Only Integration (2-3 hours)
- Create internal/database/sqlite.go
- Implement read-only connection: file:path?mode=ro&immutable=1
- Domain models matching ForkerDotNet schema
- Query functions (GetRecentJobs, GetJobDetails)
- Unit tests for read-only enforcement
```

**File**: `console-dev-task-list.md`

---

### 3. start-here-wednesday.md

**Contents**:
- Quick summary of Tuesday's decisions
- What's ready (design documents complete)
- What we accomplished (Phase 12 validation)
- Next steps (start GUI console implementation)
- Key files to review
- Important context (why Go + htmx, why not alternatives)
- Recommended action (Phase 1 of console)
- Quick reference commands

**Purpose**: Brief document for Wednesday morning to orient and start work immediately.

**File**: `start-here-wednesday.md`

---

## Testing Results

### Scenarios Validated âœ…

**Scenario 1 (End-to-End)**:
- âœ… File generation working
- âœ… Discovery and copy working
- âœ… Verification working
- âœ… DataGrip shows correct state transitions
- âœ… Get-FileHash shows matching SHA-256 hashes

**Scenario 2 (Corruption Detection)**:
- âœ… 10-second delay allows corruption
- âœ… Corruption function guarantees byte change
- âœ… Hash mismatch detected
- âœ… Quarantine system working
- âœ… Database audit trail created

**Scenario 5 (Stability Detection)**:
- âœ… Growing file simulation working
- âœ… Stability detection working
- âœ… finalSize calculation fixed
- âœ… File growth tracking accurate

### Scripts Working âœ…

- âœ… `Start-ForkerDemo.ps1` - Service starts in Demo mode
- âœ… `Cleanup-DemoEnvironment.ps1` - No encoding or parameter errors
- âœ… `Demo-Utilities.ps1` - All shared functions working
- âœ… `Open-ForkerDatabase-Demo.sql` - DataGrip queries working
- âœ… All 5 Run-Scenario*.ps1 scripts updated for DataGrip

---

## Errors Encountered and Fixed

### Error 1: Cleanup Script Character Encoding
**Error**: PowerShell parser errors on Unicode checkmark characters (âœ“)
```
Unexpected token 'Evidence' in expression or statement.
```
**Fix**: Replaced Unicode with ASCII (`[OK]`, `[INFO]`)

---

### Error 2: Get-ChildItem -Filter Parameter
**Error**: `-Filter` doesn't accept array of patterns
```
Cannot convert 'System.Object[]' to the type 'System.String' required by parameter 'Filter'.
```
**Fix**: Changed to `-Include` with `-Recurse`

---

### Error 3: Corruption Function Not Changing Hash
**Error**: File corruption didn't change hash - random byte might equal original
```
Source Hash:     89648BD8...
Corrupted Hash:  89648BD8...  # SAME!
```
**Fix**: Read current byte and XOR with 0xFF (flips all bits)

---

### Error 4: Scenario 5 Divide By Zero
**Error**: `$finalSize` undefined, causing division by zero
```
Attempted to divide by zero.
```
**Fix**: Capture file size before closing stream

---

### Error 5: File Explorer Windows Not Closing
**Error**: `Stop-FileExplorerGrid` only closed 2 of 3 windows
**Fix**: Improved matching logic to check both LocationName and LocationURL

---

### Error 6: SQL Reserved Word 'to'
**Error**: DataGrip errors on `to` as table alias
**Fix**: Changed all instances to `t_o`

---

### Error 7: Environment Not Loading in Program.cs
**Error**: Service loading Production config even when environment variable set
**Fix**: Added environment detection and overlay loading

---

## User Feedback Highlights

1. **On demo UX**: *"overall this is not a great user experience"*

2. **On separate console**: *"I'd like to propose an alternate option. Build a simple GUI console (needs to be deployable on NHS server so consider technology to allow this. eg dockerised?)"*

3. **On NHS deployment reality**: *"really, you think I can just drop some random exe file onto a windows machine in the NHS and run it!!!"*

4. **On technology choice**: *"I love the sound of Go + htmx but you will be doing all the work as I have no idea about this!"*

5. **On SQLite**: *"lets stick with SQLite, I'm convinced its the correct choice"*

6. **On Docker**: *"Docker as an environment to run the application from as a back end (ie webserver) and a edge/chrome browser is a definite"*

7. **On Microsoft frameworks**: *"Dont get too hung up on the 'microsoft is safe so the only one thats any good is the really old one' idea"*

---

## Architecture Insights

### Separation of Concerns

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ForkerDotNet Ecosystem                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ForkerDotNet.Service  â”‚       â”‚   GUI Console      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Critical Path          â”‚       â”‚ Monitoring Layer   â”‚   â”‚
â”‚  â”‚ Pure .NET 8            â”‚       â”‚ Go + htmx          â”‚   â”‚
â”‚  â”‚ SQLite with WAL        â”‚â—„â”€â”€â”€â”€â”€â”€â”¤ Read-only DB       â”‚   â”‚
â”‚  â”‚ No external deps       â”‚       â”‚ Browser UI         â”‚   â”‚
â”‚  â”‚ Windows Service        â”‚       â”‚ Docker container   â”‚   â”‚
â”‚  â”‚ Minimal attack surface â”‚       â”‚ 15MB image         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Principle**: Console is purely observational, zero interference with production service.

### Technology Selection Matrix

| Criteria | Go + htmx | Blazor Server | React SPA | Desktop GUI |
|----------|-----------|---------------|-----------|-------------|
| Container Size | 15MB | 200MB+ | 150MB+ | N/A |
| Dependencies | 3 packages | 50+ packages | 1000+ packages | Windows-only |
| Vulnerability Scanning | Easy | Moderate | Complex | Limited |
| NHS Deployment | Docker (acceptable) | Docker | Docker | Blocked |
| Build Complexity | None | Moderate | High | Moderate |
| Real-time Updates | SSE (native) | SignalR | WebSockets | N/A |
| Learning Curve | Low | Moderate | High | Low |

**Winner**: Go + htmx (best balance of simplicity, security, and deployability)

---

## Implementation Plan Summary

### Phase 1: Core Infrastructure (4-6 hours)
- Project bootstrap (Go module, directory structure)
- SQLite read-only integration
- Basic HTTP server with health endpoint
- Test connection to ForkerDemo database

### Phase 2: Production Dashboard (6-8 hours)
- Dashboard layout (htmx + HTML)
- Real-time job monitoring (SSE)
- Job detail view with drill-down

### Phase 3: Demo Mode (6-8 hours)
- Demo mode UI (5 scenario buttons)
- Scenario execution engine
- Demo environment validation

### Phase 4: Polish & Security (3-4 hours)
- Docker containerization (multi-stage build)
- Security scanning & hardening (Trivy, gosec, Nancy)
- Documentation & user guide

**Total Estimate**: 19-26 hours

---

## Files Modified/Created Summary

### Created Files
- âœ… `console-design.md` (500+ lines)
- âœ… `console-dev-task-list.md` (700+ lines)
- âœ… `start-here-wednesday.md` (200+ lines)
- âœ… `scripts/Start-ForkerDemo.ps1` (convenience script)
- âœ… `scripts/Open-ForkerDatabase-Demo.sql` (DataGrip queries)
- âœ… `chats/session-2025-10-07.md` (this file)

### Modified Files
- âœ… `src/Forker.Service/appsettings.Demo.json` (Testing configuration)
- âœ… `src/Forker.Infrastructure/Services/VerificationOrchestrator.cs` (Demo delays)
- âœ… `src/Forker.Service/Program.cs` (Environment detection)
- âœ… `scripts/Demo-Utilities.ps1` (Corruption fix, File Explorer cleanup)
- âœ… `scripts/Cleanup-DemoEnvironment.ps1` (Encoding fix, parameter fix)
- âœ… `scripts/Run-Scenario5-StabilityDetection.ps1` (finalSize fix)
- âœ… All 5 Run-Scenario*.ps1 scripts (DataGrip integration)
- âœ… `TASK_LIST.md` (Phase 12 complete, Phase 13 added)

---

## Next Session (Wednesday)

### Recommended Starting Point

**Begin Phase 1 of GUI Console Implementation**:

1. Create new repository `forker-console/`
2. Initialize Go module: `go mod init github.com/nhs/forker-console`
3. Create directory structure (cmd/, internal/, web/)
4. Install dependencies (go-sqlite3, chi router)
5. Implement SQLite read-only connection
6. Build basic HTTP server
7. Test connection to `C:\ForkerDemo\forker.db`

### Files to Review Before Starting

1. [console-design.md](../console-design.md) - Architecture overview
2. [console-dev-task-list.md](../console-dev-task-list.md) - Detailed tasks
3. [start-here-wednesday.md](../start-here-wednesday.md) - Quick orientation

### Success Criteria for Wednesday

**Phase 1 Complete When**:
- âœ… Console queries ForkerDotNet database successfully
- âœ… HTTP server runs without errors
- âœ… Read-only access verified
- âœ… Health endpoint returns JSON
- âœ… Domain models match ForkerDotNet schema

---

## Key Takeaways

1. **PowerShell demos work**, but UX is fragmented for reviewers
2. **GUI console will solve this** with unified monitoring and one-click demos
3. **Go + htmx chosen** for minimal dependencies and easy security scanning
4. **Separate repository** maintains separation of concerns
5. **Docker deployment** acceptable for NHS (unlike desktop executables)
6. **Read-only database access** ensures zero interference with production service
7. **Design is complete**, ready for implementation

---

## Session Metrics

- **Duration**: Full day (Tuesday, October 7th)
- **Files Modified**: 10+
- **Files Created**: 6
- **Lines of Design Documentation**: 1,400+
- **Bugs Fixed**: 7
- **Scenarios Validated**: 3 of 5
- **Architecture Decisions**: 4 major
- **Estimated Implementation Time**: 19-26 hours

---

**Status**: âœ… Phase 12 Complete | ğŸ“ Phase 13 Ready for Wednesday Implementation

**Commit Pending**: All work from this session needs to be added and committed with session export.
